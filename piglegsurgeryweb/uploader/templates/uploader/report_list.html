{% extends 'base.html' %}

{% block body %}
<div
        {% if user.is_authenticated %}
        class="container-xxl"
        {% else %}
        class="container"
        {% endif %}
>
    <a class="btn btn-secondary" href="{% url 'uploader:model_form_upload' %}">Upload next</a>
    {% if request.user.is_staff %}
    <a class="btn btn-secondary"
       href="{% url 'uploader:update_all_uploaded_files' %}">
        <i class="bi bi-arrow-clockwise"></i> Update all uploaded files
    </a>
    <a class="btn btn-secondary"
       href="{% url 'admin:index' %}">
        <i class="fa fa-gear"></i> Admin
    </a>

    {% endif %}
    <H2> List of reports </H2>
    <input id="search_here" class="form-control mb-3" placeholder="type here to search.."/>
    <table class="table">
        <thead>
        <tr>
            <th scope="col"></th>
            <th scope="col">Email</th>
            <th scope="col">File name</th>
            <th scope="col">Uploaded At</th>
            {% if user.is_authenticated %}
            <th scope="col" colspan="3"></th>
<!--            <th scope="col" colspan="2">Queue size = {{ queue_size }}</th>-->
            <th scope="col">Started At</th>
            <th scope="col">Finished At</th>
            {% endif %}
        </tr>
        </thead>
        <tbody>
        {% for uploadedfile in uploadedfiles %}
        <tr class="align-middle" id="row{{uploadedfile.id}}">
            <td scope="col">
                {% if uploadedfile.preview %}
                <!--                {{ uploadedfile.preview }}-->
                <!--                <image src="{{ uploadedfile.bitmapimage_set.all.0.bitmap_image.url }}" class="rounded img-fluid" alt="thumbnail with the processed video" style="min-width: 66px;"></image>-->
                <image src="{{ uploadedfile.preview.url }}" class="rounded img-fluid"
                       alt="thumbnail with the processed video" style="min-width: 66px; max-width: 80px;"></image>
                {% endif %}
            </td>
            <td scope="row"><a href="/uploader/web_report/{{uploadedfile.hash}}?next={{ request.path|urlencode }}">
                {{ uploadedfile.email }} </a></td>
            <td><a href="/uploader/web_report/{{uploadedfile.hash}}?next={{ request.path|urlencode }}"
                   style="word-break: break-all;"
            >
                {{ uploadedfile }}</a></td>
            <td><a href="/uploader/web_report/{{uploadedfile.hash}}?next={{ request.path|urlencode }}">
                {{ uploadedfile.uploaded_at |date:'Y-m-d H:i' }}</a></td>
            {% if user.is_authenticated %}
            <td>
                {% if uploadedfile.is_microsurgery %}
                <i class="fa-solid fa-microscope"></i><
                {% endif %}
            </td>
            <td><a class="btn btn-light"
                   href="{% url 'uploader:run' uploadedfile.id %}?next={{ request.path|urlencode }}">Run</a></td>
            <td><a class="btn btn-light"
                   href="{% url 'uploader:resend_report_email' uploadedfile.id %}?next={{ request.path|urlencode }}">Send
                Email</a></td>
            <td>{{ uploadedfile.started_at |date:'Y-m-d H:i' }}</td>
            <td>{{ uploadedfile.finished_at |date:'Y-m-d H:i' }}</td>
            {% endif %}
        </tr>
        {% endfor %}
        </tbody>
    </table>
    <a class="btn btn-secondary" href="{% url 'uploader:model_form_upload' %}">Upload next</a>
    <script>
        const data = '{{qs_json}}'

        const rdata = JSON.parse(data.replace(/&quot;/g, '"'))

        const input = document.getElementById('search_here');

        let filteredArr = []

        input.addEventListener('keyup', (e) => {
            for (const element_id in rdata) {
                if (rdata[element_id].includes(e.target.value)) {
                    const el = document.getElementById("row" + element_id);
                    el.classList.remove("d-none");
                } else {
                    document.getElementById("row" + element_id).classList.add('d-none');

                }
            }
        })

    </script>
</div>
{% endblock %}
